name: Create RDS Database

on:
  workflow_dispatch:
    inputs:
      db_password:
        description: 'Database Password (min 8 characters)'
        required: true
        type: string
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/create-rds.yml'

env:
  AWS_REGION: us-east-1

jobs:
  create-rds:
    name: Create RDS Database (Free Tier)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check if RDS instance exists
        id: check-rds
        run: |
          DB_EXISTS=$(aws rds describe-db-instances \
            --db-instance-identifier nonprofit-learning-db \
            --region ${{ env.AWS_REGION }} \
            --query "DBInstances[0].DBInstanceIdentifier" \
            --output text 2>/dev/null || echo "None")
          
          if [ "$DB_EXISTS" != "None" ] && [ -n "$DB_EXISTS" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ RDS instance already exists"
            aws rds describe-db-instances \
              --db-instance-identifier nonprofit-learning-db \
              --region ${{ env.AWS_REGION }} \
              --query "DBInstances[0].{Status:DBInstanceStatus,Endpoint:Endpoint.Address,Port:Endpoint.Port}" \
              --output table
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "RDS instance does not exist"
          fi
      
      - name: Get default VPC and subnets
        if: steps.check-rds.outputs.exists == 'false'
        id: get-vpc
        run: |
          # Get default VPC
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=isDefault,Values=true" \
            --query "Vpcs[0].VpcId" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$VPC_ID" ] || [ "$VPC_ID" == "None" ]; then
            echo "Getting any VPC..."
            VPC_ID=$(aws ec2 describe-vpcs \
              --query "Vpcs[0].VpcId" \
              --output text 2>/dev/null || echo "")
          fi
          
          echo "VPC_ID=$VPC_ID" >> $GITHUB_OUTPUT
          
          # Get subnets in VPC
          SUBNET_IDS=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query "Subnets[*].SubnetId" \
            --output text 2>/dev/null || echo "")
          
          echo "SUBNET_IDS=$SUBNET_IDS" >> $GITHUB_OUTPUT
          echo "VPC: $VPC_ID"
          echo "Subnets: $SUBNET_IDS"
      
      - name: Create DB subnet group
        if: steps.check-rds.outputs.exists == 'false'
        run: |
          SUBNET_IDS="${{ steps.get-vpc.outputs.SUBNET_IDS }}"
          if [ -z "$SUBNET_IDS" ] || [ "$SUBNET_IDS" == "None" ]; then
            echo "‚ùå No subnets found. Cannot create RDS."
            exit 1
          fi
          
          # Create subnet group if it doesn't exist
          aws rds describe-db-subnet-groups \
            --db-subnet-group-name nonprofit-learning-db-subnet-group \
            --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws rds create-db-subnet-group \
            --db-subnet-group-name nonprofit-learning-db-subnet-group \
            --db-subnet-group-description "Subnet group for Nonprofit Learning Platform" \
            --subnet-ids $SUBNET_IDS \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ DB subnet group ready"
      
      - name: Create security group for RDS
        if: steps.check-rds.outputs.exists == 'false'
        id: create-sg
        run: |
          # Check if security group exists
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=nonprofit-learning-rds-sg" \
            --query "SecurityGroups[0].GroupId" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$SG_ID" ] || [ "$SG_ID" == "None" ]; then
            echo "Creating security group..."
            SG_ID=$(aws ec2 create-security-group \
              --group-name nonprofit-learning-rds-sg \
              --description "Security group for RDS PostgreSQL" \
              --vpc-id ${{ steps.get-vpc.outputs.VPC_ID }} \
              --region ${{ env.AWS_REGION }} \
              --query "GroupId" \
              --output text)
            
            # Allow PostgreSQL from VPC
            VPC_CIDR=$(aws ec2 describe-vpcs \
              --vpc-ids ${{ steps.get-vpc.outputs.VPC_ID }} \
              --query "Vpcs[0].CidrBlock" \
              --output text)
            
            aws ec2 authorize-security-group-ingress \
              --group-id $SG_ID \
              --protocol tcp \
              --port 5432 \
              --cidr $VPC_CIDR \
              --region ${{ env.AWS_REGION }} || echo "Rule may already exist"
            
            echo "‚úÖ Security group created: $SG_ID"
          else
            echo "‚úÖ Security group already exists: $SG_ID"
          fi
          
          echo "SG_ID=$SG_ID" >> $GITHUB_OUTPUT
      
      - name: Create RDS instance (Free Tier)
        if: steps.check-rds.outputs.exists == 'false'
        env:
          DB_PASSWORD: ${{ github.event.inputs.db_password || secrets.DB_PASSWORD || 'ChangeMe123!' }}
        run: |
          echo "Creating RDS PostgreSQL instance (Free Tier compatible)..."
          
          aws rds create-db-instance \
            --db-instance-identifier nonprofit-learning-db \
            --db-instance-class db.t3.micro \
            --engine postgres \
            --engine-version 14.9 \
            --master-username postgres \
            --master-user-password "$DB_PASSWORD" \
            --allocated-storage 20 \
            --storage-type gp2 \
            --db-name nonprofit_learning \
            --vpc-security-group-ids ${{ steps.create-sg.outputs.SG_ID }} \
            --db-subnet-group-name nonprofit-learning-db-subnet-group \
            --backup-retention-period 1 \
            --region ${{ env.AWS_REGION }} \
            --no-publicly-accessible \
            --no-multi-az \
            --no-storage-encrypted || {
            echo "‚ö†Ô∏è  RDS creation failed. Check error above."
            exit 1
          }
          
          echo "‚úÖ RDS instance creation initiated!"
          echo "‚è≥ This will take 5-10 minutes to become available"
          echo ""
          echo "üìã Next steps:"
          echo "1. Wait for RDS to become 'available'"
          echo "2. Get the endpoint from AWS Console"
          echo "3. Add to GitHub Secrets as DATABASE_URL:"
          echo "   postgresql://postgres:PASSWORD@ENDPOINT:5432/nonprofit_learning"
      
      - name: Get RDS endpoint
        if: always()
        run: |
          ENDPOINT=$(aws rds describe-db-instances \
            --db-instance-identifier nonprofit-learning-db \
            --region ${{ env.AWS_REGION }} \
            --query "DBInstances[0].Endpoint.Address" \
            --output text 2>/dev/null || echo "Not available yet")
          
          STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier nonprofit-learning-db \
            --region ${{ env.AWS_REGION }} \
            --query "DBInstances[0].DBInstanceStatus" \
            --output text 2>/dev/null || echo "Unknown")
          
          echo "RDS Status: $STATUS"
          echo "RDS Endpoint: $ENDPOINT"
          
          if [ "$STATUS" == "available" ] && [ "$ENDPOINT" != "None" ] && [ -n "$ENDPOINT" ]; then
            echo ""
            echo "‚úÖ RDS is ready!"
            echo "DATABASE_URL=postgresql://postgres:PASSWORD@$ENDPOINT:5432/nonprofit_learning"
          else
            echo ""
            echo "‚è≥ RDS is still being created. Check AWS Console for status."
          fi
