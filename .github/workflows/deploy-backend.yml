name: Deploy Backend to AWS

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: nonprofit-learning-backend
  APP_RUNNER_SERVICE: nonprofit-learning-backend

jobs:
  deploy:
    name: Deploy to AWS App Runner
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        working-directory: ./backend
        run: |
          # Build Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Push to ECR
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to EC2
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: latest
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_SSH_PORT: ${{ secrets.EC2_SSH_PORT || '22' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_FRONTEND_API: ${{ secrets.CLERK_FRONTEND_API }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS || '*' }}
        run: |
          set -e
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ]; then
            echo "❌ Missing EC2 deployment secrets"
            echo "   Required: EC2_HOST, EC2_USER, EC2_SSH_KEY"
            exit 1
          fi

          echo "Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "$EC2_SSH_PORT" -H "$EC2_HOST" >> ~/.ssh/known_hosts

          echo "Deploying to EC2..."
          ssh -p "$EC2_SSH_PORT" "$EC2_USER@$EC2_HOST" <<EOF
          set -e
          echo "✅ Connected to EC2"

          if ! command -v docker >/dev/null 2>&1; then
            echo "❌ Docker is not installed on EC2"
            exit 1
          fi

          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          docker stop nonprofit-learning-backend || true
          docker rm nonprofit-learning-backend || true

          docker run -d \
            --name nonprofit-learning-backend \
            --restart unless-stopped \
            -p 8000:8000 \
            -e DATABASE_URL="$DATABASE_URL" \
            -e CLERK_SECRET_KEY="$CLERK_SECRET_KEY" \
            -e CLERK_PUBLISHABLE_KEY="$CLERK_PUBLISHABLE_KEY" \
            -e CLERK_FRONTEND_API="$CLERK_FRONTEND_API" \
            -e ENVIRONMENT="production" \
            -e CORS_ORIGINS="$CORS_ORIGINS" \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          echo "✅ EC2 deployment completed"
          EOF

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_FRONTEND_API: ${{ secrets.CLERK_FRONTEND_API }}
          ENVIRONMENT: production
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS || '*' }}
        run: |
          # Validate required environment variables
          if [ -z "$CLERK_SECRET_KEY" ] || [ -z "$CLERK_PUBLISHABLE_KEY" ] || [ -z "$CLERK_FRONTEND_API" ]; then
            echo "⚠️  Missing Clerk environment variables, but continuing with migrations..."
            echo "   Note: Migrations should work without Clerk vars, but config validation requires them"
          fi
          
          # Install dependencies
          cd backend
          pip install -r requirements.txt
          
          # Run migrations
          alembic upgrade head

      - name: Deployment status
        run: |
          echo "✅ Backend deployed to EC2"
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "Region: ${{ env.AWS_REGION }}"
