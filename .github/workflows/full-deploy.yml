name: Full Deployment to AWS

on:
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_migrations:
        description: 'Run Database Migrations'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches: [ main ]
    tags:
      - 'v*'

env:
  AWS_REGION: us-east-1

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_backend != 'false' || github.event_name == 'push' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: nonprofit-learning-backend
          IMAGE_TAG: ${{ github.sha }}
        working-directory: ./backend
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Deploy to App Runner
        run: |
          # Get service ARN if exists
          SERVICE_ARN=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='nonprofit-learning-backend'].ServiceArn" \
            --output text || echo "")
          
          if [ -z "$SERVICE_ARN" ]; then
            echo "Creating new App Runner service..."
            aws apprunner create-service \
              --service-name nonprofit-learning-backend \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ steps.login-ecr.outputs.registry }}/nonprofit-learning-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "8000",
                    "RuntimeEnvironmentVariables": {
                      "DATABASE_URL": "${{ secrets.DATABASE_URL }}",
                      "CLERK_SECRET_KEY": "${{ secrets.CLERK_SECRET_KEY }}",
                      "CLERK_PUBLISHABLE_KEY": "${{ secrets.CLERK_PUBLISHABLE_KEY }}",
                      "CLERK_FRONTEND_API": "${{ secrets.CLERK_FRONTEND_API }}",
                      "ENVIRONMENT": "production",
                      "CORS_ORIGINS": "${{ secrets.CORS_ORIGINS }}"
                    }
                  }
                },
                "AutoDeploymentsEnabled": true
              }' \
              --instance-configuration '{
                "Cpu": "1 vCPU",
                "Memory": "2 GB"
              }' \
              --region ${{ env.AWS_REGION }}
          else
            echo "Updating existing App Runner service..."
            aws apprunner update-service \
              --service-arn $SERVICE_ARN \
              --source-configuration '{
                "ImageRepository": {
                  "ImageIdentifier": "${{ steps.login-ecr.outputs.registry }}/nonprofit-learning-backend:latest",
                  "ImageRepositoryType": "ECR",
                  "ImageConfiguration": {
                    "Port": "8000",
                    "RuntimeEnvironmentVariables": {
                      "DATABASE_URL": "${{ secrets.DATABASE_URL }}",
                      "CLERK_SECRET_KEY": "${{ secrets.CLERK_SECRET_KEY }}",
                      "CLERK_PUBLISHABLE_KEY": "${{ secrets.CLERK_PUBLISHABLE_KEY }}",
                      "CLERK_FRONTEND_API": "${{ secrets.CLERK_FRONTEND_API }}",
                      "ENVIRONMENT": "production",
                      "CORS_ORIGINS": "${{ secrets.CORS_ORIGINS }}"
                    }
                  }
                },
                "AutoDeploymentsEnabled": true
              }' \
              --region ${{ env.AWS_REGION }}
          fi

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_frontend != 'false' || github.event_name == 'push' }}
    needs: deploy-backend
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build Next.js app
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_FRONTEND_API: ${{ secrets.CLERK_FRONTEND_API }}
        run: npm run build
      
      - name: Deploy to S3
        working-directory: ./frontend
        run: |
          # Create bucket if doesn't exist
          aws s3 mb s3://nonprofit-learning-frontend --region ${{ env.AWS_REGION }} || true
          
          # Sync files
          aws s3 sync .next/standalone/. s3://nonprofit-learning-frontend/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable"
          
          aws s3 sync .next/static s3://nonprofit-learning-frontend/_next/static \
            --delete \
            --cache-control "public, max-age=31536000, immutable"
          
          aws s3 sync public s3://nonprofit-learning-frontend/public \
            --delete \
            --cache-control "public, max-age=3600"
      
      - name: Invalidate CloudFront
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_migrations != 'false' || github.event_name == 'push' }}
    needs: deploy-backend
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          alembic upgrade head

  notify:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, run-migrations]
    if: always()
    
    steps:
      - name: Deployment status
        run: |
          echo "âœ… Deployment pipeline completed"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Migrations: ${{ needs.run-migrations.result }}"
